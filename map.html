<!DOCTYPE html>
<html>
<head>
    <title>Taxi Hiring App - Client</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css' rel='stylesheet' />
    <link rel="stylesheet" href="map.css">
    <style>
        #map {
            height: 1000px;
            width: 100%;
        }
        
    </style>
</head>
<body>
    <div class="container fields">
        <span>Location de depart</span><input type="text" id="origin" name="origin"><br><br>
        <span>Location de destination</span><input type="text" id="destination" name="destination"><br><br>
        <span>Nombre de places</span><input type="number" id="numOfPlaces" name="numOfPlaces" min="1" value="1"><br><br>
        <input type="number" id="latitude" name="latitude" value="1" hidden="">
        <input type="number" id="longitude" name="longitude" value="1" hidden="">
        <button onclick="findAvailableDrivers()">send</button>
    </div>
    <div id="map"></div>
    <div id="searching-driver-notification" class="notification">
        <p>Recherche d'un conducteur...</p>
    </div>
    <div id="driver-found-notification" class="notification">
        <p>Un conducteur arrive bientôt !</p>
    </div>
    <script>
        var clientId; // Declare clientId in the global scope

        fetch('get_client_id.php')
        .then(response => response.json())
        .then(data => {
            // Extract the client ID from the response
            clientId = data.clientId; // Assign the value to the global variable
            // Use the client ID in your JavaScript code
            console.log('Client ID:', clientId);
    
        })
        .catch(error => {
            console.error('Error fetching client ID:', error);
        });
        mapboxgl.accessToken = 'pk.eyJ1Ijoib21hcmlvbjE5IiwiYSI6ImNsdnpsdHc4ZDA2cHoyanBoMjNtanFxZ2wifQ.qEmLEcxMuZicCHHWbQ3jjA';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [3.0588, 36.7538],
            zoom: 12
        });

        function addMarker(userLocation, title = '') {
            new mapboxgl.Marker().setLngLat(userLocation).setPopup(new mapboxgl.Popup({ offset: 25 }).setText(title)).addTo(map);
        }

        function recenterMap(markers) {
            if (markers.length > 0) {
                const bounds = new mapboxgl.LngLatBounds();
                markers.forEach(marker => bounds.extend(marker));
                map.fitBounds(bounds, { padding: 20 });
            }
        }

        function drawRoute(start, end) {
            var url = `https://api.mapbox.com/directions/v5/mapbox/driving/${start[0]},${start[1]};${end[0]},${end[1]}?geometries=geojson&access_token=${mapboxgl.accessToken}`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    var route = data.routes[0].geometry;
                    if (map.getSource('route')) {
                        map.getSource('route').setData(route);
                    } else {
                        map.addLayer({
                            id: 'route',
                            type: 'line',
                            source: {
                                type: 'geojson',
                                data: route
                            },
                            layout: {
                                'line-join': 'round',
                                'line-cap': 'round'
                            },
                            paint: {
                                'line-color': '#ff0000',
                                'line-width': 5
                            }
                        });
                    }
                });
        }

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                var userLocation = [position.coords.longitude, position.coords.latitude];
                var url = 'https://api.mapbox.com/geocoding/v5/mapbox.places/' + userLocation[0] + ',' + userLocation[1] + '.json?access_token=' + mapboxgl.accessToken;
                
                fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.features && data.features.length > 0) {
                        var placeName = data.features[0].place_name;
                        document.getElementById('origin').value = placeName;
                        document.getElementById('latitude').value = position.coords.latitude;
                        document.getElementById('longitude').value = position.coords.longitude;
                        map.setCenter(userLocation);
                        addMarker(userLocation, 'Your Location');
                    } else {
                        console.error('Aucun lieu trouvé dans le contexte.');
                    }
                })
                .catch(error => {
                    console.error('Erreur lors de la récupération de la ville:', error);
                });
            }, function(error) {
                console.error('Erreur de géolocalisation: ', error);
                handleLocationError(true);
            });
        } else {
            console.error('Navigateur ne supporte pas la géolocalisation.');
            handleLocationError(false);
        }

        function handleLocationError(browserHasGeolocation) {
            var errorMessage = browserHasGeolocation ? 'Erreur: La géolocalisation a échoué.' : 'Erreur: Votre navigateur ne prend pas en charge la géolocalisation.';
            alert(errorMessage);
        }

        function displayAvailableDrivers(drivers) {
            var markers = [];
            drivers.forEach(function(driver) {
                var location = [driver.longitude, driver.latitude];
                addMarker(location, driver.name);
                markers.push(location);
                drawRoute([parseFloat(document.getElementById('longitude').value), parseFloat(document.getElementById('latitude').value)], location);
            });
            recenterMap(markers);
        }

        function findAvailableDrivers() {
            var latitude = parseFloat(document.getElementById('latitude').value);
            var longitude = parseFloat(document.getElementById('longitude').value);
            var destination = document.getElementById('destination').value;
            var numOfPlaces = parseInt(document.getElementById('numOfPlaces').value);
        
            console.log("Sending request to find drivers at: ", { latitude, longitude, destination, numOfPlaces });
        
            showNotification('searching-driver-notification');
        
            // Send POST request to Flask backend to insert client request data
            fetch('http://127.0.0.1:5000/insert_client_request', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    client_id: clientId,
                    latitude: latitude,
                    longitude: longitude,
                    destination: destination,
                    num_places: numOfPlaces
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    // Process response if needed
                }
            })
            .catch(error => {
                console.error('Error inserting client request:', error);
                hideNotification('searching-driver-notification');
            });
        
            fetch('http://127.0.0.1:5000/find_drivers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    latitude: latitude,
                    longitude: longitude,
                    destination: destination,
                    num_places: numOfPlaces
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    displayAvailableDrivers(data.drivers);
                    hideNotification('searching-driver-notification');
                    simulateDriverAccepting();
                }
            })
            .catch(error => {
                console.error('Erreur lors de la récupération des chauffeurs disponibles:', error);
                hideNotification('searching-driver-notification');
            });
        }

        function showNotification(id) {
            document.getElementById(id).classList.add('show');
        }

        function hideNotification(id) {
            document.getElementById(id).classList.remove('show');
        }

        function simulateDriverAccepting() {
            showNotification('driver-found-notification');
            setTimeout(() => {
                hideNotification('driver-found-notification');
            }, 5000);
        }

        setTimeout(simulateDriverAccepting, 10000);
    </script>
</body>
</html>

